<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ResepKepepet v2.5 - Cloud & Print</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .loader { border-top-color: #f97316; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .recipe-text { font-size: 16px; line-height: 1.7; }
        
        .recipe-card { 
            padding: 1.5rem !important;
            transition: all 0.3s ease;
            min-height: auto;
        }
        
        @media (min-width: 768px) {
            .recipe-card { 
                padding: 2.5rem !important;
                min-height: 400px;
            }
        }

        .recipe-card:hover { transform: translateY(-5px); }

        .glass-nav { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
        }

        /* --- LOGIKA CETAK (PRINT) YANG SUDAH DIPERBAIKI --- */
        @media print {
            body { background: white !important; }
            
            /* Menyembunyikan Nav, Input, Tombol Print, Settings, DAN HISTORY CONTAINER */
            nav, #input-section, #btn-print, #settings-modal, .history-btn, #history-container { 
                display: none !important; 
            }

            #results-container { 
                display: block !important; 
                position: absolute; 
                top: 0; 
                left: 0;
                width: 100%; 
                margin: 0;
                padding: 0;
            }
            
            .recipe-card { 
                border: 2px solid #eee !important; 
                margin-bottom: 30px; 
                break-inside: avoid; 
                color: black !important;
                box-shadow: none !important;
                page-break-inside: avoid;
            }
            
            .dark { background: white !important; color: black !important; }
            .dark .recipe-card { background: white !important; color: black !important; }
        }

        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen font-sans transition-colors">

    <div class="max-w-5xl mx-auto p-4 md:p-8 pb-12">
        <nav class="sticky top-2 z-40 flex justify-between items-center mb-6 p-3 md:p-4 rounded-2xl shadow-lg glass-nav dark:bg-gray-800/80 border border-white/20">
            <h1 class="text-xl md:text-2xl font-black text-orange-600 flex items-center gap-2 italic">
                üç≥ResepKepepet <span class="hidden xs:inline">ResepKepepet</span> <span class="text-[9px] md:text-[10px] bg-orange-600 text-white px-2 py-1 rounded-md not-italic uppercase tracking-widest">v2.5</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="toggleHistory()" class="history-btn px-3 py-2 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-200 rounded-xl font-bold text-xs md:text-sm active:scale-95 transition-transform">üìú Riwayat</button>
                <button onclick="toggleSettings()" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-xl hover:rotate-90 active:scale-95 transition-transform">‚öôÔ∏è</button>
            </div>
        </nav>

        <div id="input-section" class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-[2rem] md:rounded-[2.5rem] shadow-2xl mb-8 border border-slate-100 dark:border-gray-700 animate__animated animate__fadeInDown">
            <h2 class="text-lg md:text-xl font-bold mb-4 flex items-center gap-2">üõí Bahan yang kamu punya:</h2>
            <textarea id="ingredients" class="w-full p-4 md:p-6 rounded-2xl bg-slate-50 dark:bg-gray-700 border-2 border-slate-100 dark:border-gray-600 focus:border-orange-500 outline-none transition-all text-base md:text-lg mb-6" 
                rows="3" placeholder="Contoh: Tempe, Telur, Bawang Merah..."></textarea>
            
            <button onclick="generateRecipe()" id="btn-generate" 
                class="w-full bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-black py-4 md:py-5 rounded-2xl shadow-xl transform active:scale-95 transition-all text-base md:text-lg tracking-widest uppercase">
                ü™Ñ RACIK & SIMPAN CLOUD
            </button>
        </div>

        <div id="loading" class="hidden text-center py-12 md:py-20">
            <div class="loader ease-linear rounded-full border-4 md:border-8 border-t-4 md:border-t-8 border-gray-200 h-12 w-12 md:h-20 md:w-20 mx-auto mb-6"></div>
            <p class="text-xl md:text-2xl font-bold text-orange-600 animate-pulse italic">Chef AI sedang meracik...</p>
        </div>

        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 hidden">
            <div id="recipe-1" class="recipe-card bg-white dark:bg-gray-800 rounded-[1.5rem] md:rounded-[2rem] shadow-xl border-t-[8px] md:border-t-[12px] border-orange-500 animate__animated animate__fadeInUp"></div>
            <div id="recipe-2" class="recipe-card bg-white dark:bg-gray-800 rounded-[1.5rem] md:rounded-[2rem] shadow-xl border-t-[8px] md:border-t-[12px] border-red-500 animate__animated animate__fadeInUp"></div>
        </div>

        <button id="btn-print" onclick="window.print()" class="hidden w-full mt-6 bg-gray-800 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
            üñ®Ô∏è CETAK (PDF / KERTAS)
        </button>

        <div id="history-container" class="mt-10 hidden animate__animated animate__fadeInUp">
            <div class="flex justify-between items-center mb-6 px-2">
                <h3 class="text-xl md:text-2xl font-black text-blue-600 italic">‚òÅÔ∏è Cloud History</h3>
                <button onclick="toggleHistory()" class="text-sm text-gray-400 hover:text-gray-600">Tutup</button>
            </div>
            <div id="history-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm hidden p-2 md:p-4">
        <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-[1.5rem] md:rounded-[2rem] p-6 md:p-8 shadow-2xl animate__animated animate__zoomIn max-h-[95vh] overflow-y-auto">
            <h3 class="text-xl md:text-2xl font-black mb-6 text-orange-600 italic">Kitchen Settings</h3>
            <div class="space-y-4 md:space-y-5">
                <div>
                    <label class="block text-[10px] font-bold mb-1 md:mb-2 uppercase opacity-50">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 md:p-4 rounded-xl border dark:bg-gray-700 dark:border-gray-600 text-sm" placeholder="Paste API Key...">
                </div>
                <div>
                    <label class="block text-[10px] font-bold mb-1 md:mb-2 uppercase opacity-50">Model ID</label>
                    <input type="text" id="model-input" class="w-full p-3 md:p-4 rounded-xl border dark:bg-gray-700 dark:border-gray-600 font-mono text-sm" placeholder="gemini-2.0-flash-exp">
                </div>
                
                <p class="text-[10px] text-gray-400 italic mt-2 border-t pt-2 dark:border-gray-600">
                    * Konfigurasi Firebase tertanam di dalam kode sumber (HTML).
                </p>

                <button onclick="saveSettings()" class="w-full bg-orange-600 text-white font-black py-4 rounded-xl active:scale-95 transition shadow-lg">SIMPAN</button>
                <button onclick="toggleSettings()" class="w-full text-xs text-gray-400 font-bold uppercase py-2">Tutup</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // ==========================================
        // --- KONFIGURASI FIREBASE ---
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC67ZMqywH6Nj_Jm5EjStcT4xq_qRv7yB8",
            authDomain: "kulkas-ai.firebaseapp.com",
            projectId: "kulkas-ai",
            storageBucket: "kulkas-ai.firebasestorage.app",
            messagingSenderId: "364317481294",
            appId: "1:364317481294:web:d2e69c3b82b54b1d0e661f",
            measurementId: "G-G4LH0L728M"
        };
        // ==========================================

        let db;
        
        try {
            if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes(".....")) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("üî• Firebase Connected!");
            } else {
                console.warn("‚ö†Ô∏è Firebase Config belum diisi di dalam script HTML.");
            }
        } catch (e) { 
            console.error("Firebase Init Error:", e); 
        }

        window.deleteRecipe = async (event, docId) => {
            event.stopPropagation();
            if (!confirm("Yakin ingin menghapus resep ini dari history?")) return;
            try {
                await deleteDoc(doc(db, "recipes", docId));
                alert("Resep berhasil dihapus.");
                document.getElementById('history-container').classList.add('hidden');
                toggleHistory();
            } catch (e) {
                alert("Gagal menghapus: " + e.message);
            }
        };

        window.generateRecipe = async () => {
            const key = localStorage.getItem('gemini_api_key');
            const model = localStorage.getItem('gemini_selected_model') || "gemini-1.5-flash";
            const bahan = document.getElementById('ingredients').value;

            if (!key || !bahan) {
                alert("Mohon lengkapi API Key Gemini dan Bahan makanan!");
                toggleSettings(); 
                return;
            }

            const loading = document.getElementById('loading');
            const results = document.getElementById('results-container');
            const btnPrint = document.getElementById('btn-print');

            loading.classList.remove('hidden');
            results.classList.add('hidden');
            btnPrint.classList.add('hidden');

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            const prompt = `Bahan: ${bahan}. Berikan 2 resep dalam JSON: {"resep1": {"nama": "", "bahan_kurang": [], "cara_masak": []}, "resep2": {"nama": "", "bahan_kurang": [], "cara_masak": []}}. Gunakan font size 16px feeling dalam deskripsi cara masak.`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (!data.candidates) throw new Error("Gagal mengambil data dari AI.");

                const rawText = data.candidates[0].content.parts[0].text;
                const cleanJson = JSON.parse(rawText.replace(/```json|```/g, ''));

                renderRecipe('recipe-1', cleanJson.resep1, 'orange');
                renderRecipe('recipe-2', cleanJson.resep2, 'red');

                results.classList.remove('hidden');
                btnPrint.classList.remove('hidden');
                confetti({ particleCount: 100, spread: 60, origin: { y: 0.8 } });

                if (db) {
                    try {
                        await addDoc(collection(db, "recipes"), {
                            bahan: bahan,
                            data: cleanJson,
                            date: new Date()
                        });
                    } catch (err) {
                        console.error("Gagal simpan ke history:", err);
                    }
                }
                
                window.scrollTo({ top: results.offsetTop - 80, behavior: 'smooth' });

            } catch (e) { 
                alert("Error: " + e.message); 
                console.error(e);
            }
            finally { loading.classList.add('hidden'); }
        };

        window.toggleHistory = async () => {
            const container = document.getElementById('history-container');
            const list = document.getElementById('history-list');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                return;
            }

            if (!db) {
                list.innerHTML = "<p class='col-span-2 text-center text-red-500 py-4'>‚ö†Ô∏è Konfigurasi Firebase belum diisi di dalam Source Code HTML.</p>";
                return;
            }

            list.innerHTML = "<p class='col-span-2 text-center animate-pulse py-4'>Mengambil data cloud...</p>";
            
            try {
                const q = query(collection(db, "recipes"), orderBy("date", "desc"), limit(6));
                const snap = await getDocs(q);
                
                list.innerHTML = "";
                if (snap.empty) {
                    list.innerHTML = "<p class='col-span-2 text-center text-gray-400 py-4'>Belum ada riwayat resep.</p>";
                }

                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const docId = docSnap.id;
                    
                    const div = document.createElement('div');
                    div.className = "bg-white dark:bg-gray-800 p-4 rounded-xl shadow border-l-8 border-blue-500 mx-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition relative group";
                    const dateStr = item.date && item.date.seconds ? new Date(item.date.seconds * 1000).toLocaleDateString('id-ID') : '';
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class='font-black text-orange-600 text-sm flex-1 mr-2'>${item.data.resep1.nama}</h4>
                            <div class="flex items-center gap-2">
                                <span class='text-[9px] text-gray-400'>${dateStr}</span>
                                <button onclick="deleteRecipe(event, '${docId}')" class="p-1 rounded-md bg-red-100 hover:bg-red-200 text-red-600 transition" title="Hapus Permanen">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        <p class='text-[10px] opacity-50 truncate mt-1 pr-8'>${item.bahan}</p>
                    `;
                    
                    div.onclick = () => {
                         renderRecipe('recipe-1', item.data.resep1, 'orange');
                         renderRecipe('recipe-2', item.data.resep2, 'red');
                         document.getElementById('results-container').classList.remove('hidden');
                         document.getElementById('btn-print').classList.remove('hidden');
                         window.scrollTo({ top: document.getElementById('results-container').offsetTop - 80, behavior: 'smooth' });
                    };
                    list.appendChild(div);
                });
            } catch (err) {
                list.innerHTML = `<p class='col-span-2 text-center text-red-500 py-4'>Gagal memuat: ${err.message}</p>`;
            }
        };
    </script>

    <script>
        const toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden');
        
        const saveSettings = () => {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-input').value.trim();
            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.setItem('gemini_selected_model', model);
            alert("Pengaturan Berhasil Disimpan! Halaman akan dimuat ulang.");
            location.reload();
        };

        function renderRecipe(id, data, color) {
            document.getElementById(id).innerHTML = `
                <h2 class="text-2xl md:text-3xl font-black text-${color}-600 mb-4 md:mb-6 italic uppercase tracking-tighter leading-tight">
                    ${data.nama}
                </h2>
                
                <div class="mb-6 md:mb-8">
                    <h4 class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">‚ö†Ô∏è Bahan Tambahan:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${data.bahan_kurang.map(b => `<span class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs px-3 py-1 rounded-full font-bold border border-red-100 dark:border-red-800">+ ${b}</span>`).join('')}
                    </div>
                </div>

                <div class="recipe-text">
                    <h4 class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">üë®‚Äçüç≥ Langkah Memasak:</h4>
                    <ol class="list-decimal list-outside ml-5 md:ml-6 space-y-3 md:space-y-4 text-gray-700 dark:text-gray-300">
                        ${data.cara_masak.map(step => `<li>${step}</li>`).join('')}
                    </ol>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('api-key-input').value = localStorage.getItem('gemini_api_key') || "";
            document.getElementById('model-input').value = localStorage.getItem('gemini_selected_model') || "gemini-2.0-flash-exp";
        });
    </script>
</body>
</html>
